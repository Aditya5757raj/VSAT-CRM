<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VSAT CRM - Dashboard</title>
  <link rel="stylesheet" href="../css/dashboard.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    /* ======== Layout & Headings ======== */
    .section {
  display: none;
}
.section.active {
  display: block;
}


    h2 {
      margin-bottom: 12px;
      font-size: 22px;
      font-weight: 600;
    }

    .filter-section {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    /* ======== Table Styling ======== */
    table {
      border-collapse: collapse;
      width: 100%;
      text-align: center;
      font-size: 14px;
      background-color: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      overflow: hidden;
    }

    th,
    td {
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      vertical-align: middle;
    }

    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #333;
    }

    td {
      color: #555;
    }

    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tbody tr:hover {
      background-color: #f1f1f1;
    }

    /* ======== Status Badges ======== */
    .badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
    }

    .badge.pending {
      background: #f4a261;
      color: #fff;
    }

    .badge.approved {
      background: #2a9d8f;
      color: #fff;
    }

    .badge.rejected {
      background: #e63946;
      color: #fff;
    }

    .badge.dispatched {
      background: #457b9d;
      color: #fff;
    }

    .badge.completed {
      background: #2b9348;
      color: #fff;
    }

    /* ======== Action Buttons ======== */
    .action-buttons {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    .action-btn {
      padding: 6px 8px;
      border-radius: 6px;
      background: #f4f4f4;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn i {
      font-size: 14px;
      color: #444;
    }

    .action-btn:hover {
      background: #ddd;
    }

    html,
    body {
      height: 100%;
      overflow: auto;
    }

    .table-container {
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #ddd;
    }

    .modal {
      display: none;
    }

    .modal-content p {
      margin: 6px 0;
    }

    /* Modal background */
#viewPoModal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
  overflow-y: auto;
}

/* Modal box */
#viewPoModal .modal-content {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  max-width: 800px;
  width: 90%;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  animation: fadeIn 0.3s ease-in-out;
}

/* Header */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.modal-header h2 {
  font-size: 20px;
  font-weight: bold;
}
.modal-header .close-btn {
  font-size: 20px;
  cursor: pointer;
  color: #666;
}
.modal-header .close-btn:hover {
  color: #000;
}

/* Grid Layout for Details */
.modal-body {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.modal-section {
  background: #f9f9f9;
  border-radius: 8px;
  padding: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.modal-section h3 {
  font-size: 16px;
  margin-bottom: 8px;
  font-weight: 600;
  color: #333;
}
.modal-section p {
  margin: 4px 0;
  font-size: 14px;
  color: #555;
}
.modal-section p strong {
  color: #222;
}
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 600px;
  width: 90%;
  margin: auto;
}


/* Animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}


    /* ======== Responsive Design ======== */
    @media (max-width: 1024px) {
      table {
        font-size: 12px;
      }

      th,
      td {
        padding: 8px;
      }
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" style="width: 250px; background-color: #f4f4f4; height: 100vh;">
      <div class="sidebar-header" style="padding: 20px; overflow: visible;">
        <div class="logo" style="display: flex; align-items: center; gap: 16px; max-width: 100%;">
          <img src="../assets/logo1.png" alt="VSAT Logo"
            style="height: 80px; width: 80px; object-fit: contain; border-radius: 8px; background-color: white; padding: 6px;">
          <div class="logo-text" style="line-height: 1.2;">
            <h1 style="font-size: 20px; margin: 0; color: #0d47a1;">VSAT CRM</h1>
            <p style="font-size: 13px; margin: 4px 0 0; color: #444;">Warehouse Dashboard</p>
          </div>
        </div>
      </div>

      <!-- Navigation Menu -->
      <nav class="sidebar-nav" style="padding: 0 20px;">
        <div class="nav-section">
          <p class="nav-title" style="margin: 10px 0; font-weight: bold;">Main Menu</p>
          <ul class="nav-list" style="list-style: none; padding: 0;">
            <li>
              <button class="nav-item active" data-section="po-status">
                <i class="fas fa-list-alt"></i> Dashboard
              </button>
            </li>
            <li>
                <button class="nav-item" data-section="grm">
                    <i class="fas fa-clipboard-check"></i> GRM
                </button>
            </li>
          </ul>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
          </button>
          <h2>Customer Service Portal</h2>
        </div>
        <div class="header-right">
          <button class="refresh-btn" id="headerRefreshBtn" title="Refresh Dashboard">
            <i class="fas fa-sync-alt"></i>
          </button>
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search customers, jobs...">
          </div>
          <button class="notification-btn">
            <i class="fas fa-bell"></i>
          </button>
          <div class="user-profile">
            <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">JD</div>
            <div class="user-info">
              <div class="user-name" id="userName">Loading...</div>
              <div class="user-role" id="userRole">Loading...</div>
            </div>

            <!-- User Dropdown Menu -->
            <div class="user-dropdown" id="userDropdown">
              <div class="dropdown-item" id="changePasswordBtn">
                <i class="fas fa-key"></i>
                <span>Change Password</span>
              </div>
              <div class="dropdown-item" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- PO Status Section -->
      <main class="main-content" style="padding: 20px; flex-grow: 1;">
        <section id="po-status" class="section active">
          <div class="section-header">
            <h2> Purchase Order Status</h2>
            <p>Track and manage purchase order status</p>
          </div>

          <div class="filter-section">
            <div class="card">
              <div class="card-header">
                <h3>Filter by Status</h3>
              </div>
              <div class="tabs-container">
                <div class="tabs">
                  <button class="tab-btn active" data-status="pending">Pending</button>
                  <button class="tab-btn" data-status="dispatched">Dispatched</button>
                  <button class="tab-btn" data-status="delivered">Delivered</button>
                  <button class="tab-btn" data-status="cancelled">Cancelled</button>
                </div>
              </div>
            </div>
          </div>

          <div id="poStatusContent"></div>
        </section>
      </main>
    </div>
  </div>

  <div id="viewPoModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Purchase Order Details</h2>
      <span class="close-btn" onclick="closeViewModal()">×</span>
    </div>
    <div class="modal-body">
      <div class="modal-section">
        <h3>Basic Information</h3>
        <p><strong>PO Number:</strong> <span id="viewPoNumber"></span></p>
        <p><strong>Model Number:</strong> <span id="viewModelNumber"></span></p>
        <p><strong>Part Code:</strong> <span id="viewPartCode"></span></p>
        <p><strong>Complaint ID:</strong> <span id="viewComplaintId"></span></p>
      </div>
      <div class="modal-section">
        <h3>Quantity</h3>
        <p><strong>Requested Quantity:</strong> <span id="viewRequestedQuantity"></span></p>
        <p><strong>Status:</strong> <span id="viewStatus"></span></p>
      </div>
      <div class="modal-section">
        <h3>Dates</h3>
        <p><strong>Created Date:</strong> <span id="viewCreatedDate"></span></p>
      </div>
      <div class="modal-section">
        <h3>Courier Details</h3>
        <p><strong>Docket Name:</strong> <span id="viewDocketName"></span></p>
        <p><strong>Courier Name:</strong> <span id="viewCourierName"></span></p>
        <p><strong>Received Status:</strong> <span id="viewReceivedStatus"></span></p>
      </div>
    </div>
  </div>
</div>

<div id="editPOModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditPOModal()">&times;</span>
    <h3>Edit Purchase Order</h3>
    <form id="editPOForm">
      <label>Docket Name</label>
      <input type="text" id="editDocketName" />

      <label>Courier Name</label>
      <input type="text" id="editCourierName" />

      <label>Received Status</label>
      <select id="editReceivedStatus">
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>

      <button type="button" onclick="saveEditedPO()">Save Changes</button>
    </form>
  </div>
</div>

<!-- GRM Section -->
<section id="grm" class="section">
  <div class="section-header">
    <h2><i class="fas fa-shipping-fast"></i> Goods Receipt Management</h2>
    <p>Manage dispatched orders and goods receipt</p>
  </div>

  <div class="results-section">
    <div class="card">
      <div class="card-header">
        <h3>Dispatched Orders</h3>
      </div>
      <div class="card-body">
        <div id="grmLoadingIndicator" class="loading-indicator" style="display: none;">
          <i class="fas fa-spinner fa-spin"></i> Loading dispatched orders...
        </div>

        <div class="table-container">
          <table class="jobs-table">
            <thead>
              <tr>
                <th>PO Number</th>
                <th>Model Number</th>
                <th>Part Code</th>
                <th>Quantity</th>
                <th>Docket Name</th>
                <th>Courier</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="grmTableBody">
              <!-- Dynamic GRM content inserted by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- GRM Edit Modal -->
<div id="editGrmModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-edit"></i> Edit GRM Order</h3>
      <span class="close-btn" onclick="closeEditGrmModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="editGrmForm">
        <div class="form-grid">
          <div class="form-group">
            <label>PO Number</label>
            <input type="text" id="editGrmPoNumber" readonly />
          </div>
          <div class="form-group">
            <label>Model Number</label>
            <input type="text" id="editGrmModelNumber" readonly />
          </div>
          <div class="form-group">
            <label>Part Code</label>
            <input type="text" id="editGrmPartCode" readonly />
          </div>
          <div class="form-group">
            <label>Requested Quantity</label>
            <input type="text" id="editGrmRequestedQuantity" readonly />
          </div>
          <div class="form-group">
            <label>Received Status</label>
            <select id="editGrmReceivedStatus">
              <option value="received_ok">Received OK</option>
              <option value="received_short">Received Short</option>
              <option value="excess">Excess</option>
              <option value="received_defective">Received Defective</option>
            </select>
          </div>
          <div class="form-group" id="shortQuantityGroup" style="display: none;">
            <label>Short Quantity</label>
            <input type="number" id="editShortQuantity" placeholder="Enter short quantity" min="0">
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="saveGrmChanges()">
        <i class="fas fa-save"></i> Save Changes
      </button>
      <button class="btn btn-outline" onclick="closeEditGrmModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- GRM View Modal (reuse existing viewPoModal) -->
<!-- Already compatible with grm.js, no need for separate modal -->
<script>
// Helper: Get cookie by name
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
  return null;
}

// Fetch PO Status from backend
async function loadPOStatus(status) {
  const container = document.getElementById("poStatusContent");
  container.innerHTML = `<p>Loading ${status} POs...</p>`;

  try {
    const token = getCookie("token");
    if (!token) {
      container.innerHTML = `<p style="color:red;">No token found. Please log in again.</p>`;
      return;
    }

    const response = await fetch(`${API_URL}/warehouse/getparts?status=${status}`, {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || "Network error");
    }

    const data = await response.json();
    console.log("📦 PO data:", data);

    if (!data || data.length === 0) {
      container.innerHTML = `<p>No ${status} POs found.</p>`;
      return;
    }

    // Create table with action buttons
    let table = `
      <table border="1" cellpadding="8" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th>PO Number</th>
            <th>Model Number</th>
            <th>Part Code</th>
            <th>Complaint ID</th>
            <th>Quantity</th>
            <th>Status</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
    `;

    data.forEach(order => {
      const orderData = encodeURIComponent(JSON.stringify(order));
      table += `
        <tr>
          <td><span class="po-number">${order.po_number || 'N/A'}</span></td>
          <td>${order.model_number || 'N/A'}</td>
          <td>${order.part_code || 'N/A'}</td>
          <td>${order.complaint_id || 'N/A'}</td>
          <td>${order.requested_quantity || 0}</td>
          <td><span class="badge ${getStatusBadgeClass(order.status)}">${order.status || 'Pending'}</span></td>
          <td>${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'N/A'}</td>
          <td>
            <div class="action-buttons">
              <button class="action-btn" onclick="viewPODetails('${orderData}')" title="View Details">
                <i class="fas fa-eye"></i>
              </button>
              ${order.status && order.status.toLowerCase() === 'pending' ? `
                <button class="action-btn" onclick="editPOOrder('${orderData}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>` : ''}
              <button class="action-btn" onclick="printPODetails('${orderData}')" title="Print">
                <i class="fas fa-print"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    });

    table += `</tbody></table>`;
    container.innerHTML = table;

  } catch (error) {
    console.error("❌ Error loading PO Status:", error);
    container.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
  }
}

// Status badge class
function getStatusBadgeClass(status) {
  if (!status) return 'pending';
  return status.toLowerCase();
}

// Example action functions
function viewPODetails(orderData) {
  try {
    const order = JSON.parse(decodeURIComponent(orderData));
    document.getElementById("viewPoNumber").textContent = order.po_number || 'N/A';
    document.getElementById("viewModelNumber").textContent = order.model_number || 'N/A';
    document.getElementById("viewPartCode").textContent = order.part_code || 'N/A';
    document.getElementById("viewComplaintId").textContent = order.complaint_id || 'N/A';
    document.getElementById("viewRequestedQuantity").textContent = order.requested_quantity || 'N/A';
    document.getElementById("viewStatus").textContent = order.status || 'Pending';
    document.getElementById("viewCreatedDate").textContent = order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'N/A';
    document.getElementById("viewDocketName").textContent = order.docket_name || 'N/A';
    document.getElementById("viewCourierName").textContent = order.courier_name || 'N/A';
    document.getElementById("viewReceivedStatus").textContent = order.received_status || 'Not Received';

    let modal = document.getElementById("viewPoModal");
    modal.style.display = "flex";
    document.body.style.overflow = "hidden";
  } catch (error) {
    console.error("Error viewing PO details:", error);
  }
}
function closeViewModal() {
  let modal = document.getElementById("viewPoModal");
  modal.style.display = "none";
  document.body.style.overflow = "auto";
}
function editPOOrder(orderData) {
  try {
    const order = JSON.parse(decodeURIComponent(orderData));
    document.getElementById("editDocketName").value = order.docket_name || '';
    document.getElementById("editCourierName").value = order.courier_name || '';
    document.getElementById("editReceivedStatus").value = order.received_status || 'No';
    document.getElementById("editPOModal").style.display = "flex"; // use flex for centering
    window.currentEditingPO = order;
  } catch (e) {
    console.error("Error opening edit modal:", e);
  }
}
function saveEditedPO() {
  if (!window.currentEditingPO) return;
  window.currentEditingPO.docket_name = document.getElementById("editDocketName").value;
  window.currentEditingPO.courier_name = document.getElementById("editCourierName").value;
  window.currentEditingPO.received_status = document.getElementById("editReceivedStatus").value;
  console.log("Updated PO:", window.currentEditingPO);
  closeEditPOModal();
}
function closeEditPOModal() {
  document.getElementById("editPOModal").style.display = "none";
}
function printPODetails(orderData) {
  const order = JSON.parse(decodeURIComponent(orderData));
  console.log("Printing PO:", order);
}

// Auto-load default "Pending" POs on page load
document.addEventListener("DOMContentLoaded", function () {
  console.log("✅ Page loaded, calling loadPOStatus...");
  loadPOStatus("pending");
});

// Handle tab clicks
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    this.classList.add("active");
    loadPOStatus(this.getAttribute("data-status"));
  });
});

// Sidebar navigation section toggle
document.querySelectorAll(".nav-item").forEach(btn => {
  btn.addEventListener("click", function () {
    // Remove 'active' from all nav buttons
    document.querySelectorAll(".nav-item").forEach(b => b.classList.remove("active"));
    this.classList.add("active");

    const sectionId = this.getAttribute("data-section");

    // Hide all sections
    document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));

    // Show the clicked section
    const section = document.getElementById(sectionId);
    if (section) section.classList.add("active");

    // Load section-specific data only once per section
    if (sectionId === "grm") {
      if (!section.dataset.loaded) {
        loadGrmData();
        section.dataset.loaded = "true";
      }
    }
    if (sectionId === "po-status") {
      if (!section.dataset.loaded) {
        loadPOStatus("pending");
        section.dataset.loaded = "true";
      }
    }
  });
});
</script>

  <!-- Toast Notification Container -->
  <div id="toastContainer"></div>

  <!-- Mobile Navigation Toggle -->
  <script src="../js/Config.js"></script>
  <script src="../js/inventory.js"></script>
  <script src="../js/warehouse_user.js"></script>
</body>

</html>
